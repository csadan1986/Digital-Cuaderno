<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cuaderno Digital </title>

<!-- Manifest y otros meta -->
<link rel="manifest" href="manifest.json" />
<link rel="apple-touch-icon" href="icon-192.png" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="theme-color" content="#2c2c2c" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #eee;
  }
  header {
    background: #2c2c2c;
    color: white;
    padding: 12px;
    text-align: center;
  }
  #folderSelector {
    margin: 10px auto;
    text-align: center;
    background: #ddd;
    padding: 6px 10px;
  }
  #folderSelector select, #folderSelector button {
    margin-left: 8px;
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #888;
    cursor: pointer;
  }
  #folderSelector button {
    background: #4CAF50;
    color: white;
    border: none;
  }
  #symbolCategories {
    margin: 10px auto;
    text-align: center;
    background: #ddd;
    padding: 6px 0;
  }
  #symbolCategories button {
    margin: 0 6px;
    padding: 6px 14px;
    border: none;
    background: #bbb;
    color: #222;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
  }
  #symbolCategories button.active, #symbolCategories button:hover {
    background: #2c2c2c;
    color: white;
  }
  #symbolsBar {
    overflow-x: auto;
    white-space: nowrap;
    background: #ccc;
    padding: 5px 10px;
  }
  #symbolsBar button {
    font-size: 18px;
    padding: 4px 8px;
    background: white;
    border: 1px solid #888;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
    margin-right: 4px;
    transition: background-color 0.2s;
  }
  #symbolsBar button:hover {
    background-color: #ddd;
  }
  #pageTabs {
    display: flex;
    overflow-x: auto;
    background: #ddd;
    padding: 5px;
    border-bottom: 1px solid #aaa;
    align-items: center;
    flex-wrap: wrap;
  }
  .tab {
    padding: 8px 15px;
    margin-right: 5px;
    background: #bbb;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    user-select: none;
    position: relative;
    display: flex;
    align-items: center;
    white-space: nowrap;
  }
  .tab.active {
    background: #2c2c2c;
    color: white;
    font-weight: bold;
  }
  .tab .close-btn {
    margin-left: 8px;
    background: #ff4c4c;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    line-height: 16px;
    text-align: center;
    cursor: pointer;
    font-size: 14px;
  }
  #addPageBtn {
    padding: 8px 15px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    user-select: none;
  }
  #fontSelect, #colorPicker, #fontSizeSelect {
    margin-left: 10px;
    padding: 5px;
    border-radius: 6px;
    border: 1px solid #888;
  }
  #editor {
    background: white;
    width: 90%;
    max-width: 900px;
    min-height: 400px;
    margin: 15px auto 30px;
    padding: 15px;
    border-radius: 6px;
    outline: none;
    overflow-y: auto;
    font-family: Arial, sans-serif;
    color: black;
    position: relative;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  button.insertImageBtn, button.insertDialogBtn, button.checkGrammarBtn, button.savePdfBtn {
    display: inline-block;
    margin: 10px 5px 10px 0;
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    border: none;
    background: #4CAF50;
    color: white;
  }
  img {
    max-width: 100%;
    height: auto;
  }
  /* Burbuja di√°logo */
  .dialog-bubble {
    position: relative;
    display: inline-block;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 20px;
    background: #dceefc;
    max-width: 60%;
    font-size: 1em;
    font-family: Arial, sans-serif;
    color: #000;
    box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
    user-select: text;
  }
  .dialog-bubble::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 20px;
    width: 0;
    height: 0;
    border: 15px solid transparent;
    border-top-color: #dceefc;
    border-bottom: 0;
    border-left: 0;
    margin-left: -7px;
    margin-bottom: -15px;
  }
  /* Otra forma de di√°logo */
  .dialog-oval {
    border-radius: 50px 10px 50px 10px;
    background: #ffd966;
    color: #333;
  }

  /* Estilo para el resaltado del buscador */
  .highlight {
    background-color: #ff6666;
    color: black;
  }

  /* Contenedor del buscador */
  #searchContainer {
    width: 90%;
    max-width: 900px;
    margin: 15px auto 0 auto;
    text-align: center;
  }
  #searchInput {
    width: 70%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #888;
    font-size: 16px;
  }
  #searchBtn {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    background-color: #2c2c2c;
    color: white;
    cursor: pointer;
    font-size: 16px;
    margin-left: 8px;
  }
  #clearSearchBtn {
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    background-color: #888;
    color: white;
    cursor: pointer;
    font-size: 16px;
    margin-left: 8px;
  }

  /* Contenedor para resultados de b√∫squeda */
  #searchResults {
    width: 90%;
    max-width: 900px;
    margin: 5px auto;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    padding: 8px;
    display: none;
  }
</style>
</head>
<body>

<header>üìò Cuaderno Digital</header>

<!-- Selector de carpeta -->
<div id="folderSelector" title="Selecciona carpeta">
  Carpeta:
  <select id="folderSelect"></select>
  <button id="newFolderBtn" title="Nueva Carpeta">+ Nueva Carpeta</button>
</div>

<!-- Selector de categor√≠as de s√≠mbolos -->
<div id="symbolCategories" title="Selecciona categor√≠a de s√≠mbolos">
  <button data-cat="figuras" class="active">Figuras</button>
  <button data-cat="flechas">Flechas</button>
  <button data-cat="matematicas">Matem√°ticas</button>
  <button data-cat="emojis">Emojis</button>
  <button data-cat="infinitos">S√≠mbolos</button>
</div>

<!-- Barra de s√≠mbolos -->
<div id="symbolsBar" title="Haz clic para insertar s√≠mbolo"></div>

<!-- Barra de p√°ginas y controles -->
<div id="pageTabs">
  <button id="addPageBtn" title="Agregar p√°gina">+ Nueva P√°gina</button>
  <select id="fontSelect" title="Cambiar fuente">
    <option value="Arial, sans-serif">Arial</option>
    <option value="'Courier New', monospace">Courier New</option>
    <option value="'Times New Roman', serif">Times New Roman</option>
    <option value="Georgia, serif">Georgia</option>
    <option value="Verdana, sans-serif">Verdana</option>
  </select>
  <select id="fontSizeSelect" title="Cambiar tama√±o de fuente">
    <option value="12px">12</option>
    <option value="14px" selected>14</option>
    <option value="16px">16</option>
    <option value="18px">18</option>
    <option value="20px">20</option>
    <option value="24px">24</option>
    <option value="28px">28</option>
    <option value="32px">32</option>
  </select>
  <input type="color" id="colorPicker" title="Cambiar color de texto" value="#000000" />
  <button class="insertDialogBtn" title="Insertar di√°logo en burbuja">üí¨ Insertar Di√°logo</button>
  <button class="checkGrammarBtn" title="Corregir gram√°tica">‚úîÔ∏è Corregir Gram√°tica</button>
  <button class="savePdfBtn" title="Guardar como PDF">üìÑ Guardar PDF</button>
</div>

<!-- Buscador interno -->
<div id="searchContainer" title="Buscar texto dentro del cuaderno">
  <input type="text" id="searchInput" placeholder="Buscar palabra o frase..." />
  <button id="searchBtn" title="Buscar">Buscar</button>
  <button id="clearSearchBtn" title="Limpiar b√∫squeda">Limpiar</button>
</div>

<!-- Contenedor para resultados b√∫squeda global -->
<div id="searchResults"></div>

<!-- Editor -->
<div id="editor" contenteditable="true" spellcheck="true" placeholder="Escribe aqu√≠ tus apuntes..."></div>

<!-- Insertar imagen -->
<button class="insertImageBtn" onclick="selectImage()">üì∑ Insertar imagen</button>
<input type="file" id="imgInput" accept="image/*" style="display:none" />

<!-- Librer√≠as para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const editor = document.getElementById('editor');
const imgInput = document.getElementById('imgInput');
const folderSelect = document.getElementById('folderSelect');
const newFolderBtn = document.getElementById('newFolderBtn');
const pageTabs = document.getElementById('pageTabs');
const addPageBtn = document.getElementById('addPageBtn');
const fontSelect = document.getElementById('fontSelect');
const fontSizeSelect = document.getElementById('fontSizeSelect');
const colorPicker = document.getElementById('colorPicker');
const symbolCategories = document.getElementById('symbolCategories');
const symbolsBar = document.getElementById('symbolsBar');
const insertDialogBtn = document.querySelector('.insertDialogBtn');
const checkGrammarBtn = document.querySelector('.checkGrammarBtn');
const savePdfBtn = document.querySelector('.savePdfBtn');

const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearchBtn');
const searchResults = document.getElementById('searchResults');

let pages = {};
let currentFolder = null;
let currentPageId = null;

const symbolsByCategory = {
  figuras: [
    "‚úì", "‚òÖ", "‚óè", "‚ñ†", "‚ñ≤", "‚ô•", "‚àû", "‚òÄ", "‚òÅ", "‚òÇ", "‚òÉ", "‚úø", "‚úà", "‚úâ", "‚òï", "‚ö°", "‚ô†", "‚ô£", "‚ô¶",
    "‚óâ", "‚¨§", "‚¨õ", "‚¨ú", "‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚¨ÖÔ∏è", "‚û°Ô∏è", "‚¨∞", "‚¨±", "‚¨≤", "‚¨≥", "‚¨¥", "‚¨µ", "‚¨∂", "‚¨∑", "‚¨∏", "‚¨π"
  ],
  flechas: [
    "‚Üê", "‚Üë", "‚Üí", "‚Üì", "‚Üî", "‚Üï", "‚áê", "‚áë", "‚áí", "‚áì", "‚áî", "‚áï", "‚¨Ü", "‚¨á", "‚¨Ö", "‚û°", "‚Ü©", "‚Ü™",
    "‚Ü∫", "‚Üª", "‚á§", "‚á•", "‚á¶", "‚áß", "‚á®", "‚á©", "‚Üû", "‚Üü", "‚Ü†", "‚Ü°", "‚Ü¢", "‚Ü£"
  ],
  matematicas: [
    "+", "‚àí", "√ó", "√∑", "=", "‚â†", "‚âà", "<", ">", "‚â§", "‚â•", "¬±", "‚àö", "‚àë", "‚àè", "‚à´", "‚àÇ", "‚àû", "‚àá", "‚àù",
    "‚àà", "‚àâ", "‚àÖ", "‚à™", "‚à©", "‚äÇ", "‚äÉ", "‚äÜ", "‚äá", "‚àÄ", "‚àÉ", "‚àß", "‚à®", "‚äï", "‚äó", "‚Ñµ"
  ],
  emojis: [
    "üòÄ", "üòÇ", "üòç", "üòé", "üëç", "üôè", "üî•", "üí°", "üéâ", "üöÄ", "üåü", "üåà", "üçÄ", "üéµ", "üòä", "üò¢", "üò°", "ü§î",
    "ü§ñ", "üëª", "üí©", "ü§©", "ü•≥", "üò¥", "üòá", "ü§†", "ü§°", "ü•∫", "ü§ê", "ü§ë", "ü§ï", "üò∑"
  ],
  infinitos: [
    "‚àû", "‚àù", "‚àÇ", "‚àá", "‚à´", "‚àë", "‚àè", "‚âà", "‚â†", "¬±", "‚àö", "‚àà", "‚àâ", "‚àÖ", "‚à™", "‚à©",
    "‚ôæÔ∏è", "‚û∞", "„Ä∞Ô∏è", "‚ûø", "‚àΩ", "‚àº", "‚âÉ", "‚âÖ", "‚âÜ", "‚âá"
  ]
};

// Inserta s√≠mbolo en editor
function insertSymbol(symbol) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) {
    editor.innerHTML += symbol;
    saveCurrentPage();
    return;
  }
  const range = sel.getRangeAt(0);
  range.deleteContents();
  const textNode = document.createTextNode(symbol);
  range.insertNode(textNode);
  range.setStartAfter(textNode);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
  saveCurrentPage();
}

// Carga s√≠mbolos seg√∫n categor√≠a
function loadSymbols(category) {
  symbolsBar.innerHTML = "";
  symbolsByCategory[category].forEach(symbol => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.textContent = symbol;
    btn.dataset.symbol = symbol;
    btn.addEventListener("click", () => {
      insertSymbol(symbol);
      editor.focus();
    });
    symbolsBar.appendChild(btn);
  });
  symbolCategories.querySelectorAll("button").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.cat === category);
  });
}

// Carga carpetas y p√°ginas guardadas
function loadFolders() {
  const saved = localStorage.getItem('cuaderno_pages');
  if (saved) {
    pages = JSON.parse(saved);
  } else {
    pages = { "General": { "page-1": "" } };
  }
  currentFolder = Object.keys(pages)[0];
  loadFolderOptions();
  loadCurrentFolderPages();
}

// Carga opciones del selector de carpeta
function loadFolderOptions() {
  folderSelect.innerHTML = '';
  Object.keys(pages).forEach(folder => {
    const opt = document.createElement('option');
    opt.value = folder;
    opt.textContent = folder;
    folderSelect.appendChild(opt);
  });
  folderSelect.value = currentFolder;
}

folderSelect.addEventListener('change', (e) => {
  saveCurrentPage();
  currentFolder = e.target.value;
  loadCurrentFolderPages();
});

newFolderBtn.addEventListener('click', () => {
  const newFolder = prompt("Nombre de nueva carpeta:");
  if (!newFolder) return;
  if (pages[newFolder]) {
    alert("La carpeta ya existe.");
    return;
  }
  saveCurrentPage();
  pages[newFolder] = {};
  currentFolder = newFolder;
  createNewPage(true);
  loadFolderOptions();
  renderTabs();
});

function loadCurrentFolderPages() {
  const folderPages = pages[currentFolder];
  if (!folderPages || Object.keys(folderPages).length === 0) {
    createNewPage(true);
    return;
  }
  currentPageId = Object.keys(folderPages)[0];
  renderTabs();
  loadCurrentPage();
}

function savePages() {
  localStorage.setItem('cuaderno_pages', JSON.stringify(pages));
}

function saveCurrentPage() {
  if (currentFolder && currentPageId) {
    pages[currentFolder][currentPageId] = editor.innerHTML;
    savePages();
  }
}

function loadCurrentPage() {
  const content = pages[currentFolder][currentPageId] || "";
  editor.innerHTML = content;
  setEditorStyle();
}

function createNewPage(selectNew = false) {
  if (!pages[currentFolder]) pages[currentFolder] = {};
  const pageCount = Object.keys(pages[currentFolder]).length;
  const newPageId = "page-" + (pageCount + 1);
  pages[currentFolder][newPageId] = "";
  savePages();
  if (selectNew) {
    currentPageId = newPageId;
    renderTabs();
    loadCurrentPage();
  } else {
    renderTabs();
  }
}

function renderTabs() {
  // Limpia todos los tabs menos el bot√≥n agregar y controles
  const tabs = Array.from(pageTabs.querySelectorAll('.tab'));
  tabs.forEach(tab => pageTabs.removeChild(tab));

  const folderPages = pages[currentFolder];
  if (!folderPages) return;
  Object.keys(folderPages).forEach(pageId => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (pageId === currentPageId ? ' active' : '');
    tab.textContent = pageId.replace("page-", "P√°gina ");
    tab.title = `Carpeta: ${currentFolder} - P√°gina: ${pageId.replace("page-", "P√°gina ")}`;

    // Click para cambiar de p√°gina
    tab.addEventListener('click', () => {
      saveCurrentPage();
      currentPageId = pageId;
      renderTabs();
      loadCurrentPage();
      clearHighlights();
    });

    // Bot√≥n cerrar p√°gina
    const closeBtn = document.createElement('button');
    closeBtn.className = 'close-btn';
    closeBtn.textContent = '√ó';
    closeBtn.title = 'Cerrar p√°gina';
    closeBtn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      if (confirm('¬øEliminar esta p√°gina?')) {
        delete pages[currentFolder][pageId];
        if (pageId === currentPageId) {
          const remaining = Object.keys(pages[currentFolder]);
          currentPageId = remaining.length ? remaining[0] : null;
          if (!currentPageId) {
            createNewPage(true);
          }
        }
        savePages();
        renderTabs();
        loadCurrentPage();
        clearHighlights();
      }
    });

    tab.appendChild(closeBtn);
    pageTabs.insertBefore(tab, addPageBtn);
  });
}

addPageBtn.addEventListener('click', () => {
  createNewPage(true);
});

fontSelect.addEventListener('change', () => {
  setEditorStyle();
  saveCurrentPage();
});
fontSizeSelect.addEventListener('change', () => {
  setEditorStyle();
  saveCurrentPage();
});
colorPicker.addEventListener('input', () => {
  setEditorStyle();
  saveCurrentPage();
});

function setEditorStyle() {
  editor.style.fontFamily = fontSelect.value;
  editor.style.fontSize = fontSizeSelect.value;
  editor.style.color = colorPicker.value;
}

// Insertar di√°logo en burbuja
insertDialogBtn.addEventListener('click', () => {
  const sel = window.getSelection();
  if (!sel.rangeCount) {
    alert("Selecciona un texto para poner en di√°logo.");
    return;
  }
  const range = sel.getRangeAt(0);
  const selectedText = sel.toString();
  if (!selectedText.trim()) {
    alert("Selecciona un texto para poner en di√°logo.");
    return;
  }

  // Crear el contenedor de di√°logo
  const dialogSpan = document.createElement('span');
  dialogSpan.className = 'dialog-bubble';
  dialogSpan.textContent = selectedText;

  // Reemplazar el texto seleccionado por el di√°logo
  range.deleteContents();
  range.insertNode(dialogSpan);

  // Mover el cursor al final del di√°logo
  const newRange = document.createRange();
  newRange.setStartAfter(dialogSpan);
  newRange.collapse(true);
  sel.removeAllRanges();
  sel.addRange(newRange);

  saveCurrentPage();
  editor.focus();
});

// Funci√≥n para corregir gram√°tica (simplificada)
checkGrammarBtn.addEventListener('click', async () => {
  const text = editor.textContent;
  if (!text.trim()) {
    alert("El editor est√° vac√≠o.");
    return;
  }
  checkGrammarBtn.disabled = true;
  checkGrammarBtn.textContent = '‚è≥ Corrigiendo...';

  try {
    const response = await fetch('https://api.languagetool.org/v2/check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        text: text,
        language: 'es',
        enabledOnly: false
      })
    });
    const data = await response.json();

    if (data.matches && data.matches.length > 0) {
      let correctedText = text;
      const corrections = data.matches
        .map(match => ({
          offset: match.offset,
          length: match.length,
          replacements: match.replacements
        }))
        .sort((a, b) => b.offset - a.offset);

      corrections.forEach(corr => {
        if (corr.replacements && corr.replacements.length > 0) {
          const before = correctedText.slice(0, corr.offset);
          const after = correctedText.slice(corr.offset + corr.length);
          const replacement = corr.replacements[0].value;
          correctedText = before + replacement + after;
        }
      });

      editor.textContent = correctedText;
      alert("Texto corregido autom√°ticamente.");
      saveCurrentPage();
    } else {
      alert("No se encontraron errores.");
    }
  } catch (e) {
    alert("Error al conectar con el servicio de correcci√≥n.");
    console.error(e);
  } finally {
    checkGrammarBtn.disabled = false;
    checkGrammarBtn.textContent = '‚úîÔ∏è Corregir Gram√°tica';
  }
});

// Guardar como PDF
savePdfBtn.addEventListener('click', async () => {
  saveCurrentPage();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  // Usar html2canvas para convertir editor en imagen y luego poner en PDF
  const canvas = await html2canvas(editor, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');
  const imgProps = pdf.getImageProperties(imgData);
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  pdf.save('cuaderno.pdf');
});

// Insertar imagen
function selectImage() {
  imgInput.click();
}
imgInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    const img = document.createElement('img');
    img.src = event.target.result;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';

    // Insertar imagen en cursor
    const sel = window.getSelection();
    if (!sel || !sel.rangeCount) {
      editor.appendChild(img);
    } else {
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(img);
      range.setStartAfter(img);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
    saveCurrentPage();
  };
  reader.readAsDataURL(file);
  e.target.value = '';
});

// Insertar s√≠mbolo en editor al pulsar en barra de s√≠mbolos
symbolCategories.addEventListener('click', e => {
  if (e.target.tagName === 'BUTTON') {
    loadSymbols(e.target.dataset.cat);
  }
});

// Resaltado para b√∫squeda
function highlightSearch(term) {
  clearHighlights();
  if (!term) return;

  const text = editor.innerHTML;
  const escapedTerm = term.replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&');
  const regex = new RegExp(escapedTerm, 'gi');

  editor.innerHTML = text.replace(regex, match => `<span class="highlight">${match}</span>`);
}

function clearHighlights() {
  const highlighted = editor.querySelectorAll('span.highlight');
  highlighted.forEach(span => {
    span.outerHTML = span.textContent;
  });
}

// --- B√öSQUEDA GLOBAL ---

searchBtn.onclick = () => {
  const term = searchInput.value.trim();
  if (!term) {
    alert("Ingresa un texto para buscar.");
    return;
  }
  searchInAllFolders(term);
};

clearSearchBtn.onclick = () => {
  searchInput.value = "";
  clearHighlights();
  searchResults.style.display = 'none';
  searchResults.innerHTML = '';
  editor.focus();
};

function searchInAllFolders(term) {
  clearHighlights();
  searchResults.innerHTML = '';
  searchResults.style.display = 'block';

  const escapedTerm = term.replace(/[-[\]/{}()*+?.\\^$|]/g, '\\$&');
  const regex = new RegExp(escapedTerm, 'gi');

  let totalMatches = 0;

  for (const folder in pages) {
    const folderPages = pages[folder];
    for (const pageId in folderPages) {
      const content = folderPages[pageId];
      // Quitar etiquetas HTML para buscar en texto plano
      const plainText = content.replace(/<[^>]+>/g, '');
      if (regex.test(plainText)) {
        totalMatches++;

        // Crear snippet de contexto alrededor de la primera coincidencia
        const index = plainText.search(regex);
        const snippetLength = 60;
        let start = Math.max(0, index - snippetLength / 2);
        let end = Math.min(plainText.length, index + snippetLength / 2);
        let snippet = plainText.substring(start, end);
        if (start > 0) snippet = "..." + snippet;
        if (end < plainText.length) snippet = snippet + "...";

        // Crear div resultado
        const resultDiv = document.createElement('div');
        resultDiv.style.padding = "4px 6px";
        resultDiv.style.cursor = "pointer";
        resultDiv.style.borderBottom = "1px solid #ddd";
        resultDiv.title = `Carpeta: ${folder} - P√°gina: ${pageId.replace("page-", "P√°gina ")}`;
        resultDiv.innerHTML = `<strong>${folder} / ${pageId.replace("page-", "P√°gina ")}</strong>: ${snippet.replace(regex, match => `<span class="highlight">${match}</span>`)}`;

        resultDiv.onclick = () => {
          // Cambiar carpeta y p√°gina
          saveCurrentPage();
          currentFolder = folder;
          currentPageId = pageId;
          folderSelect.value = folder;
          loadFolderOptions();
          loadCurrentFolderPages();

          // Despu√©s de cargar contenido, resaltar el t√©rmino
          setTimeout(() => {
            highlightSearch(term);
          }, 200);

          // Ocultar resultados y limpiar b√∫squeda
          searchResults.style.display = 'none';
          searchInput.value = '';
        };

        searchResults.appendChild(resultDiv);
      }
    }
  }

  if (totalMatches === 0) {
    searchResults.innerHTML = "<i>No se encontraron resultados.</i>";
  }
}

// Guardar cambios al salir del editor (opcional)
editor.addEventListener('input', () => {
  saveCurrentPage();
});

// Inicializar al cargar p√°gina
window.addEventListener('load', () => {
  loadFolders();
  loadSymbols('figuras');
  setEditorStyle();
});

</script>
</body>
</html>

